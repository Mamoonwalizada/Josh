<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>نمایه - Josh</title>
  <link rel="icon" type="image/x-icon" href="https://i.ibb.co/2Y0TgqYr/file-00000000a56462468cec427eb252720e.png">
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Vazirmatn', 'Tahoma', 'sans-serif'],
          },
          colors: {
            primary: {
              500: '#1e3a8a',
              600: '#1e40af',
              700: '#1e3a8a',
            },
            secondary: {
              500: '#10b981',
              600: '#059669',
            },
            danger: {
              500: '#ef4444',
              600: '#dc2626',
            },
            accent: {
              500: '#f59e0b',
            },
          },
          boxShadow: {
            'glass': '0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08)',
            'glass-lg': '0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05)',
          },
          backdropFilter: {
            'blur': 'blur(12px)',
          },
        },
      },
    };
  </script>
  <style>
    body {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .profile-ring {
      box-shadow: 0 0 0 4px #3b82f6, 0 0 20px rgba(59, 130, 246, 0.3);
      transition: transform 0.3s ease;
    }

    .profile-ring:hover {
      transform: scale(1.05);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.9);
      padding: 2rem;
      border-radius: 1rem;
      max-width: 28rem;
      width: 90%;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .delete-confirmation-input {
      direction: ltr;
      text-align: center;
      letter-spacing: 0.1em;
    }

    .scroll-to-top {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1e3a8a, #3b82f6);
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .scroll-to-top.visible {
      opacity: 1;
      visibility: visible;
    }

    .scroll-to-top:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1e3a8a;
      color: #ffffff;
      padding: 0.75rem 1.25rem;
      border-radius: 0.75rem;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }

    .notification.visible {
      opacity: 1;
      transform: translateY(0);
    }

    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .animate-fadeInScale {
      animation: fadeInScale 0.5s ease-out;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <button class="scroll-to-top" id="scrollToTop" aria-label="بازگشت به بالا">
    <i class="fas fa-arrow-up"></i>
  </button>
  <div id="app"></div>

  <!-- React & Firebase Libraries -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDLfUbSG30O474XPAPY8QpMzo19EMfLWFc",
      authDomain: "josh-7b6a0.firebaseapp.com",
      databaseURL: "https://josh-7b6a0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "josh-7b6a0",
      storageBucket: "josh-7b6a0.appspot.com",
      messagingSenderId: "639816255525",
      appId: "1:639816255525:web:71a3e87374c3e7c68e17cc",
      measurementId: "G-P2ZSBTN8FP"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(app);
    const database = firebase.database(app);

    const ProfilePage = () => {
      const [user, setUser] = useState(null);
      const [profile, setProfile] = useState(null);
      const [loading, setLoading] = useState(true);
      const [showLogoutModal, setShowLogoutModal] = useState(false);
      const [showDeleteModal, setShowDeleteModal] = useState(false);
      const [deleteConfirmation, setDeleteConfirmation] = useState('');
      const [deleting, setDeleting] = useState(false);

      const showNotification = useCallback((message) => {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.classList.add('visible');
        }, 10);

        setTimeout(() => {
          notification.classList.remove('visible');
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }, []);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((authUser) => {
          try {
            if (!authUser) {
              Swal.fire({
                title: 'لطفاً وارد شوید',
                text: 'برای دسترسی به پروفایل باید وارد حساب کاربری شوید',
                icon: 'warning',
                confirmButtonText: 'متوجه شدم',
                confirmButtonColor: '#1e3a8a',
                background: 'rgba(255, 255, 255, 0.9)',
                backdrop: true
              }).then(() => {
                window.location.href = 'index.html';
              });
              return;
            }

            const isSocialLogin = authUser.providerData?.some(
              provider => provider.providerId === 'google.com' || provider.providerId === 'facebook.com'
            );

            if (!authUser.emailVerified && !isSocialLogin) {
              Swal.fire({
                title: 'تأیید ایمیل لازم است',
                text: 'لطفاً ایمیل خود را تأیید کنید',
                icon: 'warning',
                confirmButtonText: 'متوجه شدم',
                confirmButtonColor: '#1e3a8a',
                background: 'rgba(255, 255, 255, 0.9)',
                backdrop: true
              }).then(() => {
                window.location.href = 'index.html';
              });
              return;
            }

            setUser(authUser);
            loadProfileData(authUser.uid);
          } catch (error) {
            console.error('Auth state error:', error);
            showNotification('خطا در بررسی وضعیت ورود');
          }
        });

        return () => unsubscribe();
      }, [showNotification]);

      const loadProfileData = useCallback((userId) => {
        setLoading(true);
        const userRef = database.ref('users/' + userId);

        userRef.on('value', (snapshot) => {
          try {
            if (snapshot.exists()) {
              setProfile(snapshot.val());
            } else {
              showNotification('اطلاعات کاربر یافت نشد');
            }
            setLoading(false);
          } catch (error) {
            console.error('Error loading profile:', error);
            showNotification('خطا در بارگذاری اطلاعات پروفایل');
            setLoading(false);
          }
        }, (error) => {
          console.error('Error fetching data:', error);
          showNotification('خطا در دریافت اطلاعات');
          setLoading(false);
        });
      }, [showNotification]);

      const handleLogout = useCallback(async () => {
        try {
          await auth.signOut();
          setShowLogoutModal(false);
          Swal.fire({
            title: 'خروج موفق',
            text: 'شما با موفقیت از حساب خود خارج شدید',
            icon: 'success',
            confirmButtonText: 'متوجه شدم',
            confirmButtonColor: '#1e3a8a',
            background: 'rgba(255, 255, 255, 0.9)',
            backdrop: true
          }).then(() => {
            window.location.href = 'index.html';
          });
        } catch (error) {
          console.error('Logout error:', error);
          showNotification('خطا در خروج از حساب');
        }
      }, [showNotification]);

      const handleDeleteAccount = useCallback(async () => {
        if (deleteConfirmation !== 'حذف') {
          Swal.fire({
            title: 'ورودی نامعتبر',
            text: 'لطفاً کلمه "حذف" را به درستی وارد کنید',
            icon: 'error',
            confirmButtonText: 'متوجه شدم',
            confirmButtonColor: '#1e3a8a',
            background: 'rgba(255, 255, 255, 0.9)',
            backdrop: true
          });
          return;
        }

        setDeleting(true);
        try {
          const userRef = database.ref('users/' + user.uid);
          await userRef.remove();
          await user.delete();

          Swal.fire({
            title: 'حساب حذف شد',
            text: 'حساب کاربری شما با موفقیت حذف شد',
            icon: 'success',
            confirmButtonText: 'متوجه شدم',
            confirmButtonColor: '#1e3a8a',
            background: 'rgba(255, 255, 255, 0.9)',
            backdrop: true
          }).then(() => {
            window.location.href = 'index.html';
          });
        } catch (error) {
          console.error('Delete account error:', error);
          if (error.code === 'auth/requires-recent-login') {
            Swal.fire({
              title: 'ورود مجدد لازم است',
              text: 'برای حذف حساب، لطفاً مجدداً وارد شوید',
              icon: 'error',
              confirmButtonText: 'متوجه شدم',
              confirmButtonColor: '#1e3a8a',
              background: 'rgba(255, 255, 255, 0.9)',
              backdrop: true
            }).then(() => {
              auth.signOut();
              window.location.href = 'index.html';
            });
          } else {
            showNotification('خطا در حذف حساب');
          }
        } finally {
          setDeleting(false);
          setShowDeleteModal(false);
          setDeleteConfirmation('');
        }
      }, [deleteConfirmation, user, showNotification]);

      const toggleScrollToTop = useCallback(() => {
        const scrollToTop = document.getElementById('scrollToTop');
        scrollToTop.classList.toggle('visible', window.scrollY > 300);
      }, []);

      useEffect(() => {
        window.addEventListener('scroll', toggleScrollToTop);
        document.getElementById('scrollToTop').addEventListener('click', () => {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        return () => {
          window.removeEventListener('scroll', toggleScrollToTop);
        };
      }, [toggleScrollToTop]);

      const isEmailVerified = useMemo(() => {
        return user?.emailVerified || user?.providerData?.some(
          provider => provider.providerId === 'google.com' || provider.providerId === 'facebook.com'
        );
      }, [user]);

      if (!user) {
        return (
          <div className="flex flex-col items-center justify-center min-h-screen">
            <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600"></div>
            <p className="mt-4 text-gray-600 font-sans">در حال بررسی وضعیت احراز هویت...</p>
          </div>
        );
      }

      return (
        <div className="w-full max-w-lg mx-auto animate-fadeInScale">
          {/* Logout Confirmation Modal */}
          {showLogoutModal && (
            <div className="modal-overlay">
              <div className="modal-content">
                <h3 className="text-lg font-bold text-gray-800 mb-4 font-sans">خروج از حساب</h3>
                <p className="text-gray-600 mb-6 font-sans">آیا مطمئن هستید که میخواهید از حساب خود خارج شوید؟</p>
                <div className="flex justify-center gap-4">
                  <button
                    onClick={handleLogout}
                    className="bg-primary-500 text-white py-2 px-6 rounded-lg hover:bg-primary-600 transition-all duration-300 font-sans"
                    aria-label="تأیید خروج"
                  >
                    تأیید
                  </button>
                  <button
                    onClick={() => setShowLogoutModal(false)}
                    className="bg-gray-200 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-300 transition-all duration-300 font-sans"
                    aria-label="لغو خروج"
                  >
                    لغو
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Delete Account Confirmation Modal */}
          {showDeleteModal && (
            <div className="modal-overlay">
              <div className="modal-content">
                <div className="mb-6 text-center">
                  <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i className="fas fa-exclamation-triangle text-danger-600 text-2xl"></i>
                  </div>
                  <h3 className="text-lg font-bold text-gray-800 mb-2 font-sans">حذف حساب کاربری</h3>
                  <p className="text-gray-600 mb-4 font-sans">این عمل غیرقابل بازگشت است! تمام اطلاعات شما حذف خواهد شد.</p>
                  <p className="text-sm text-gray-500 mb-2 font-sans">لطفاً کلمه "<span className="font-bold">حذف</span>" را تایپ کنید:</p>
                  <input
                    type="text"
                    value={deleteConfirmation}
                    onChange={(e) => setDeleteConfirmation(e.target.value)}
                    className="delete-confirmation-input w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-danger-500 focus:border-transparent font-sans"
                    placeholder="حذف"
                    dir="auto"
                    aria-label="تأیید حذف حساب"
                  />
                </div>
                <div className="flex justify-center gap-4">
                  <button
                    onClick={handleDeleteAccount}
                    disabled={deleting || deleteConfirmation !== 'حذف'}
                    className={`py-2 px-6 rounded-lg transition-all duration-300 flex items-center gap-2 font-sans ${
                      deleting || deleteConfirmation !== 'حذف' 
                        ? 'bg-gray-400 cursor-not-allowed' 
                        : 'bg-danger-500 hover:bg-danger-600 text-white'
                    }`}
                    aria-label="حذف حساب"
                  >
                    {deleting ? (
                      <>
                        <div className="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white"></div>
                        در حال حذف...
                      </>
                    ) : (
                      <>
                        <i className="fas fa-trash-alt"></i>
                        حذف حساب
                      </>
                    )}
                  </button>
                  <button
                    onClick={() => {
                      setShowDeleteModal(false);
                      setDeleteConfirmation('');
                    }}
                    className="bg-gray-200 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-300 transition-all duration-300 font-sans"
                    aria-label="لغو حذف حساب"
                  >
                    لغو
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Profile Card */}
          <div className="bg-white rounded-2xl shadow-glass-lg overflow-hidden transition-all duration-300 hover:shadow-glass">
            <div className="p-6">
              {/* Profile Header */}
              <div className="flex flex-col items-center mb-6">
                <div className="relative mb-4">
                  <img
                    src={profile?.profilePhoto || 'https://via.placeholder.com/140?text=عکس+پروفایل'}
                    alt="عکس پروفایل"
                    className="w-32 h-32 rounded-full profile-ring object-cover"
                    loading="lazy"
                  />
                  {loading && (
                    <div className="absolute inset-0 bg-black bg-opacity-20 rounded-full flex items-center justify-center">
                      <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-white"></div>
                    </div>
                  )}
                  {isEmailVerified && (
                    <span className="absolute top-0 left-0 bg-secondary-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                      تأیید شده
                    </span>
                  )}
                </div>
                <h2 className="text-2xl font-bold text-primary-700 font-sans">نمایه شما</h2>
              </div>

              {/* Profile Info */}
              {loading ? (
                <div className="space-y-4">
                  <div className="h-6 bg-gray-200 rounded-full animate-pulse w-3/4 mx-auto"></div>
                  <div className="h-6 bg-gray-200 rounded-full animate-pulse w-2/3 mx-auto"></div>
                </div>
              ) : (
                <div className="space-y-4 text-center">
                  <div className="bg-gray-50 p-4 rounded-xl backdrop-blur">
                    <p className="text-gray-500 text-sm font-sans">نام کامل</p>
                    <p className="font-medium text-primary-700 font-sans">{profile?.fullname || 'نام ثبت نشده'}</p>
                  </div>
                  <div className="bg-gray-50 p-4 rounded-xl backdrop-blur">
                    <p className="text-gray-500 text-sm font-sans">شماره تلفن</p>
                    <p className="font-medium text-primary-700 font-sans">{profile?.phone || 'شماره تلفن ثبت نشده'}</p>
                  </div>
                  <div className="bg-gray-50 p-4 rounded-xl backdrop-blur">
                    <p className="text-gray-500 text-sm font-sans">ایمیل</p>
                    <p className="font-medium text-primary-700 font-sans">{user?.email || 'ایمیل ثبت نشده'}</p>
                  </div>
                </div>
              )}
            </div>

            {/* Action Buttons */}
            <div className="p-6 bg-gray-50 rounded-b-2xl space-y-3">
              <button
                onClick={() => window.location.href = 'edit_profile.html'}
                className="w-full bg-gradient-to-r from-primary-500 to-primary-600 text-white py-3 px-6 rounded-xl font-medium hover:from-primary-600 hover:to-primary-700 transition-all duration-300 flex items-center justify-center gap-2 font-sans"
                aria-label="ویرایش نمایه"
              >
                <i className="fas fa-user-edit"></i>
                ویرایش نمایه
              </button>
              <button
                onClick={() => setShowLogoutModal(true)}
                className="w-full bg-white text-primary-600 py-3 px-6 rounded-xl font-medium border border-primary-200 hover:bg-primary-50 transition-all duration-300 flex items-center justify-center gap-2 font-sans"
                aria-label="خروج از حساب"
              >
                <i className="fas fa-sign-out-alt"></i>
                خروج از حساب
              </button>
              <button
                onClick={() => setShowDeleteModal(true)}
                className="w-full bg-gradient-to-r from-danger-500 to-danger-600 text-white py-3 px-6 rounded-xl font-medium hover:from-danger-600 hover:to-danger-700 transition-all duration-300 flex items-center justify-center gap-2 font-sans"
                aria-label="حذف حساب کاربری"
              >
                <i className="fas fa-trash-alt"></i>
                حذف حساب کاربری
              </button>
              <button
                onClick={() => window.location.href = 'index.html'}
                className="w-full bg-gradient-to-r from-secondary-500 to-secondary-600 text-white py-3 px-6 rounded-xl font-medium hover:from-secondary-600 hover:to-secondary-700 transition-all duration-300 flex items-center justify-center gap-2 font-sans"
                aria-label="بازگشت به صفحه اصلی"
              >
                <i className="fas fa-home"></i>
                بازگشت به صفحه اصلی
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Render the app
    ReactDOM.render(<ProfilePage />, document.getElementById('app'));
  </script>
</body>
</html>