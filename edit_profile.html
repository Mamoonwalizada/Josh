<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نمایه - Josh</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font/dist/font-face.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Vazir', 'Tahoma', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#fdf2f8',
              100: '#fce7f3',
              200: '#fbcfe8',
              300: '#f9a8d4',
              400: '#f472b6',
              500: '#ec4899',
              600: '#db2777',
              700: '#be185d',
              800: '#9d174d',
              900: '#831843',
            },
            secondary: {
              500: '#7e22ce',
              600: '#6b21a8',
            },
            success: {
              500: '#10b981',
              600: '#059669',
            },
            danger: {
              500: '#ef4444',
              600: '#dc2626',
            },
          },
          boxShadow: {
            'neumorphism': '8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff',
            'neumorphism-inset': 'inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff',
          },
        }
      }
    }
  </script>
  <style>
    body {
      background-color: #f3f4f6;
    }
    .profile-ring {
      box-shadow: 0 0 0 4px #ec4899, 0 0 20px rgba(236, 72, 153, 0.3);
    }
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 1rem;
      max-width: 24rem;
      width: 100%;
      text-align: center;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .delete-confirmation-input {
      direction: ltr;
      text-align: center;
      letter-spacing: 0.1em;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div id="app"></div>

  <!-- React & Firebase Libraries -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDLfUbSG30O474XPAPY8QpMzo19EMfLWFc",
      authDomain: "josh-7b6a0.firebaseapp.com",
      databaseURL: "https://josh-7b6a0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "josh-7b6a0",
      storageBucket: "josh-7b6a0.appspot.com",
      messagingSenderId: "639816255525",
      appId: "1:639816255525:web:71a3e87374c3e7c68e17cc",
      measurementId: "G-P2ZSBTN8FP"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(app);
    const database = firebase.database(app);

    const ProfilePage = () => {
      const [user, setUser] = useState(null);
      const [profile, setProfile] = useState(null);
      const [loading, setLoading] = useState(true);
      const [alert, setAlert] = useState({ show: false, message: '', type: '' });
      const [showLogoutModal, setShowLogoutModal] = useState(false);
      const [showDeleteModal, setShowDeleteModal] = useState(false);
      const [deleteConfirmation, setDeleteConfirmation] = useState('');
      const [deleting, setDeleting] = useState(false);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((authUser) => {
          if (!authUser) {
            showAlert('لطفاً ابتدا وارد شوید', 'error');
            setTimeout(() => window.location.href = 'login.html', 2000);
            return;
          }
          
          // اصلاح شده: بررسی اینکه آیا کاربر از طریق ارائه‌دهنده‌های اجتماعی وارد شده است
          // کاربران با گوگل/فیسبوک نیازی به تأیید ایمیل ندارند
          const isSocialLogin = authUser.providerData && 
            authUser.providerData.some(provider => 
              provider.providerId === 'google.com' || provider.providerId === 'facebook.com'
            );
          
          if (!authUser.emailVerified && !isSocialLogin) {
            showAlert('لطفاً ابتدا ایمیل خود را تأیید کنید', 'error');
            setTimeout(() => window.location.href = 'login.html', 2000);
            return;
          }
          
          setUser(authUser);
          loadProfileData(authUser.uid);
        });

        return () => unsubscribe();
      }, []);

      const loadProfileData = (userId) => {
        setLoading(true);
        
        const userRef = database.ref('users/' + userId);
        
        userRef.on('value', (snapshot) => {
          if (snapshot.exists()) {
            setProfile(snapshot.val());
          } else {
            showAlert('اطلاعات کاربر یافت نشد', 'error');
          }
          setLoading(false);
        }, (error) => {
          console.error('خطا در دریافت اطلاعات:', error);
          showAlert('خطا در دریافت اطلاعات نمایه', 'error');
          setLoading(false);
        });
      };

      const handleLogout = async () => {
        try {
          await auth.signOut();
          setShowLogoutModal(false);
          showAlert('شما با موفقیت خارج شدید', 'success');
          setTimeout(() => window.location.href = 'index.html', 1500); // تغییر مسیر به index.html
        } catch (error) {
          console.error('خطا در خروج:', error.code, error.message);
          showAlert(`خطا در خروج از حساب: ${error.message}`, 'error');
        }
      };

      const handleDeleteAccount = async () => {
        if (deleteConfirmation !== 'حذف') {
          showAlert('لطفاً کلمه "حذف" را به درستی تایپ کنید', 'error');
          return;
        }

        setDeleting(true);
        try {
          // حذف اطلاعات از دیتابیس
          const userRef = database.ref('users/' + user.uid);
          await userRef.remove();
          
          // حذف کاربر از Authentication
          await user.delete();
          
          showAlert('حساب کاربری شما با موفقیت حذف شد', 'success');
          setTimeout(() => window.location.href = 'index.html', 2000); // تغییر مسیر به index.html
        } catch (error) {
          console.error('خطا در حذف حساب:', error.code, error.message);
          
          if (error.code === 'auth/requires-recent-login') {
            showAlert('برای حذف حساب، لطفاً مجدداً وارد شوید', 'error');
            setTimeout(() => {
              auth.signOut();
              window.location.href = 'login.html';
            }, 2000);
          } else {
            showAlert(`خطا در حذف حساب: ${error.message}`, 'error');
          }
        } finally {
          setDeleting(false);
          setShowDeleteModal(false);
          setDeleteConfirmation('');
        }
      };

      const showAlert = (message, type) => {
        setAlert({ show: true, message, type });
        setTimeout(() => setAlert({ ...alert, show: false }), 5000);
      };

      if (!user) {
        return (
          <div className="flex flex-col items-center justify-center min-h-screen">
            <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600"></div>
            <p className="mt-4 text-gray-600">در حال بررسی وضعیت احراز هویت...</p>
          </div>
        );
      }

      return (
        <div className="w-full max-w-md">
          {/* Alert Notification */}
          {alert.show && (
            <div className={`mb-6 p-4 rounded-lg ${alert.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
              {alert.message}
              <button 
                onClick={() => setAlert({ ...alert, show: false })}
                className="mr-2 text-sm font-medium"
              >
                ✕
              </button>
            </div>
          )}

          {/* Logout Confirmation Modal */}
          {showLogoutModal && (
            <div className="modal-overlay">
              <div className="modal-content">
                <h3 className="text-lg font-bold text-gray-800 mb-4">خروج از حساب</h3>
                <p className="text-gray-600 mb-6">آیا مطمئن هستید که می‌خواهید از حساب خود خارج شوید؟</p>
                <div className="flex justify-center gap-4">
                  <button
                    onClick={handleLogout}
                    className="bg-primary-500 text-white py-2 px-4 rounded-lg hover:bg-primary-600 transition-all duration-300"
                  >
                    تأیید
                  </button>
                  <button
                    onClick={() => setShowLogoutModal(false)}
                    className="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-all duration-300"
                  >
                    لغو
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Delete Account Confirmation Modal */}
          {showDeleteModal && (
            <div className="modal-overlay">
              <div className="modal-content">
                <div className="mb-6 text-center">
                  <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i className="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                  </div>
                  <h3 className="text-lg font-bold text-gray-800 mb-2">حذف حساب کاربری</h3>
                  <p className="text-gray-600 mb-4">این عمل غیرقابل بازگشت است! تمام اطلاعات شما حذف خواهد شد.</p>
                  <p className="text-sm text-gray-500 mb-2">لطفاً کلمه "<span className="font-bold">حذف</span>" را تایپ کنید تا عمل حذف تأیید شود:</p>
                  <input
                    type="text"
                    value={deleteConfirmation}
                    onChange={(e) => setDeleteConfirmation(e.target.value)}
                    className="delete-confirmation-input w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500 focus:border-transparent"
                    placeholder="حذف"
                    dir="auto"
                  />
                </div>
                <div className="flex justify-center gap-4">
                  <button
                    onClick={handleDeleteAccount}
                    disabled={deleting || deleteConfirmation !== 'حذف'}
                    className={`py-2 px-4 rounded-lg transition-all duration-300 flex items-center gap-2 ${
                      deleting || deleteConfirmation !== 'حذف' 
                        ? 'bg-gray-400 cursor-not-allowed' 
                        : 'bg-red-500 hover:bg-red-600 text-white'
                    }`}
                  >
                    {deleting ? (
                      <>
                        <div className="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white"></div>
                        در حال حذف...
                      </>
                    ) : (
                      <>
                        <i className="fas fa-trash-alt"></i>
                        حذف حساب
                      </>
                    )}
                  </button>
                  <button
                    onClick={() => {
                      setShowDeleteModal(false);
                      setDeleteConfirmation('');
                    }}
                    className="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-all duration-300"
                  >
                    لغو
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Profile Card */}
          <div className="bg-white rounded-2xl shadow-xl overflow-hidden transition-all duration-300 hover:shadow-2xl">
            <div className="p-6">
              {/* Profile Header */}
              <div className="flex flex-col items-center mb-6">
                <div className="relative mb-4">
                  <img 
                    src={profile?.profilePhoto || 'https://via.placeholder.com/140?text=عکس+پروفایل'} 
                    alt="عکس پروفایل" 
                    className="w-32 h-32 rounded-full profile-ring object-cover"
                  />
                  {loading && (
                    <div className="absolute inset-0 bg-black bg-opacity-20 rounded-full flex items-center justify-center">
                      <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-white"></div>
                    </div>
                  )}
                </div>
                <h2 className="text-2xl font-bold text-gray-800">نمایه شما</h2>
              </div>

              {/* Profile Info */}
              {loading ? (
                <div className="space-y-4">
                  <div className="h-6 bg-gray-200 rounded-full animate-pulse w-3/4 mx-auto"></div>
                  <div className="h-6 bg-gray-200 rounded-full animate-pulse w-2/3 mx-auto"></div>
                </div>
              ) : (
                <div className="space-y-4 text-center">
                  <div className="bg-gray-50 p-4 rounded-xl">
                    <p className="text-gray-500 text-sm">نام کامل</p>
                    <p className="font-medium text-gray-800">{profile?.fullname || 'نام ثبت نشده'}</p>
                  </div>
                  <div className="bg-gray-50 p-4 rounded-xl">
                    <p className="text-gray-500 text-sm">شماره تلفن</p>
                    <p className="font-medium text-gray-800">{profile?.phone || 'شماره تلفن ثبت نشده'}</p>
                  </div>
                </div>
              )}
            </div>

            {/* Action Buttons */}
            <div className="p-6 bg-gray-50 rounded-b-2xl space-y-3">
              <button 
                onClick={() => window.location.href = 'edit_profile.html'}
                className="w-full bg-gradient-to-r from-primary-500 to-secondary-500 text-white py-3 px-6 rounded-xl font-medium hover:from-primary-600 hover:to-secondary-600 transition-all duration-300 flex items-center justify-center gap-2"
              >
                <i className="fas fa-user-edit"></i>
                ویرایش نمایه
              </button>
              <button 
                onClick={() => setShowLogoutModal(true)}
                className="w-full bg-white text-primary-600 text-primary-600 py-3 px-6 rounded-xl font-medium border border-primary-200 hover:bg-primary-50 transition-all duration-300 flex items-center justify-center gap-2"
              >
                <i className="fas fa-sign-out-alt"></i>
                خروج از حساب
              </button>
              <button 
                onClick={() => setShowDeleteModal(true)}
                className="w-full bg-gradient-to-r from-danger-500 to-red-600 text-white py-3 px-6 rounded-xl font-medium hover:from-danger-600 hover:to-red-700 transition-all duration-300 flex items-center justify-center gap-2"
              >
                <i className="fas fa-trash-alt"></i>
                حذف حساب کاربری
              </button>
              <button 
                onClick={() => window.location.href = 'index.html'}
                className="w-full bg-gradient-to-r from-success-500 to-green-600 text-white py-3 px-6 rounded-xl font-medium hover:from-success-600 hover:to-green-700 transition-all duration-300 flex items-center justify-center gap-2"
              >
                <i className="fas fa-home"></i>
                بازگشت به صفحه اصلی
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Render the app
    ReactDOM.render(<ProfilePage />, document.getElementById('app'));
  </script>
</body>
</html>