<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ویرایش پروفایل - Josh</title>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font/dist/font-face.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" />
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --primary: #7b1fa2;
      --primary-dark: #4a148c;
      --primary-light: #9c27b0;
      --secondary: #d81b60;
      --secondary-dark: #b71c1c;
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --bg-light: #f8f9fa;
      --bg-white: #ffffff;
      --border-light: #e2e8f0;
      --error: #e53e3e;
      --success: #38a169;
      --warning: #dd6b20;
      --radius-md: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Vazir, Tahoma, sans-serif;
      background: var(--bg-light);
      color: var(--text-primary);
      padding: 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .profile-container {
      width: 100%;
      max-width: 500px;
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      padding: 32px 24px;
      box-shadow: var(--shadow-lg);
      position: relative;
      border: 1px solid var(--border-light);
    }

    h2 {
      margin-bottom: 24px;
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--primary-dark);
      text-align: center;
      position: relative;
      padding-bottom: 12px;
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: 50%;
      transform: translateX(50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      border-radius: 3px;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    label {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .required::after {
      content: '*';
      color: var(--error);
      font-size: 0.8rem;
      margin-right: 4px;
    }

    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    input[type="text"],
    input[type="password"],
    input[type="tel"] {
      width: 100%;
      padding: 12px 16px 12px 40px;
      font-size: 0.95rem;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      outline: none;
      transition: var(--transition);
      background-color: var(--bg-white);
      color: var(--text-primary);
    }

    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(123, 31, 162, 0.2);
    }

    .input-icon {
      position: absolute;
      right: 1px;
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .btn-group {
      margin-top: 24px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      font-family: Vazir, Tahoma, sans-serif;
      font-weight: 600;
      border: none;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      min-width: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--bg-white);
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .btn-secondary:hover {
      background: rgba(123, 31, 162, 0.05);
      border-color: var(--primary-dark);
    }

    .message {
      margin-top: 16px;
      font-size: 0.9rem;
      min-height: 20px;
      text-align: center;
    }

    /* Profile photo styles */
    .profile-photo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 24px;
      position: relative;
    }

    .profile-photo-wrapper {
      position: relative;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      padding: 4px;
      box-shadow: var(--shadow-md);
    }

    #profilePhoto {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
      background-color: #f9f0f0;
    }

    .photo-upload-btn {
      margin-top: 12px;
      background: var(--bg-white);
      color: var(--primary);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .photo-upload-btn:hover {
      background: rgba(123, 31, 162, 0.05);
      border-color: var(--primary);
    }

    #photoInput {
      display: none;
    }

    .optional-field {
      color: var(--text-secondary);
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .password-toggle {
      position: absolute;
      left: 12px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      .profile-container {
        padding: 24px 16px;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
    }

    /* Password strength indicator */
    .password-strength {
      margin-top: 4px;
      height: 4px;
      border-radius: 2px;
      background: #e2e8f0;
      overflow: hidden;
    }

    .strength-bar {
      height: 100%;
      width: 0%;
      transition: var(--transition);
    }

    .strength-weak {
      background: var(--error);
      width: 33%;
    }

    .strength-medium {
      background: var(--warning);
      width: 66%;
    }

    .strength-strong {
      background: var(--success);
      width: 100%;
    }

    .password-hints {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 4px;
      display: none;
    }

    .password-hints.show {
      display: block;
    }

    .hint-item {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }

    .hint-valid {
      color: var(--success);
    }

    .hint-invalid {
      color: var(--text-secondary);
    }

    /* Disabled styles for password fields */
    .form-group.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .form-group.disabled label {
      color: var(--text-secondary);
    }

    .form-group.disabled input {
      background-color: var(--bg-light);
      border-color: var(--border-light);
    }
  </style>
</head>
<body>

  <div class="profile-container">
    <h2>ویرایش نمایه</h2>

    <div class="profile-photo-container">
      <div class="profile-photo-wrapper">
        <img id="profilePhoto" src="https://via.placeholder.com/120?text=JP" alt="عکس نمایه" />
      </div>
      <label for="photoInput" class="photo-upload-btn">
        <span class="mdi mdi-camera"></span>
        تغییر عکس نمایه
      </label>
      <input type="file" id="photoInput" accept="image/*" capture="user" />
    </div>

    <form id="profileForm" autocomplete="off">
      <div class="form-group">
        <label for="fullname">نام کامل</label>
        <div class="input-wrapper">
          <span class="input-icon mdi mdi-account"></span>
          <input type="text" id="fullname" name="fullname" placeholder="نام و نام خانوادگی" />
        </div>
      </div>

      <div class="form-group">
        <label for="phone">شماره تلفن</label>
        <div class="input-wrapper">
          <span class="input-icon mdi mdi-phone"></span>
          <input type="tel" id="phone" name="phone" placeholder="+93XXXXXXXXX" dir="ltr" />
        </div>
      </div>

      <div class="form-group password-group" id="currentPasswordGroup">
        <label for="currentPassword">رمز عبور فعلی <span class="optional-field">(برای تغییر رمز)</span></label>
        <div class="input-wrapper">
          <span class="password-toggle mdi mdi-eye-off" id="toggleCurrentPassword"></span>
          <input type="password" id="currentPassword" name="currentPassword" placeholder="رمز عبور فعلی" />
        </div>
      </div>

      <div class="form-group password-group" id="newPasswordGroup">
        <label for="newPassword">رمز عبور جدید <span class="optional-field">(اختیاری)</span></label>
        <div class="input-wrapper">
          <span class="password-toggle mdi mdi-eye-off" id="toggleNewPassword"></span>
          <input type="password" id="newPassword" name="newPassword" placeholder="رمز عبور جدید (حداقل ۶ کاراکتر)" />
        </div>
        <div class="password-strength">
          <div class="strength-bar" id="strengthBar"></div>
        </div>
        <div class="password-hints" id="passwordHints">
          <div class="hint-item" id="lengthHint">
            <span class="mdi mdi-checkbox-blank-circle-outline"></span>
            حداقل ۶ کاراکتر
          </div>
          <div class="hint-item" id="complexityHint">
            <span class="mdi mdi-checkbox-blank-circle-outline"></span>
            شامل اعداد یا نمادها
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button type="submit" class="btn-primary">
          <span class="mdi mdi-content-save"></span>
          ذخیره تغییرات
        </button>
        <button type="button" id="cancelBtn" class="btn-secondary">
          <span class="mdi mdi-close"></span>
          انصراف
        </button>
      </div>
    </form>
  </div>

  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDLfUbSG30O474XPAPY8QpMzo19EMfLWFc",
      authDomain: "josh-7b6a0.firebaseapp.com",
      databaseURL: "https://josh-7b6a0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "josh-7b6a0",
      storageBucket: "josh-7b6a0.appspot.com",
      messagingSenderId: "639816255525",
      appId: "1:639816255525:web:71a3e87374c3e7c68e17cc",
      measurementId: "G-P2ZSBTN8FP"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // DOM elements
    const fullnameInput = document.getElementById('fullname');
    const phoneInput = document.getElementById('phone');
    const currentPasswordInput = document.getElementById('currentPassword');
    const newPasswordInput = document.getElementById('newPassword');
    const profilePhoto = document.getElementById('profilePhoto');
    const photoInput = document.getElementById('photoInput');
    const form = document.getElementById('profileForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const toggleCurrentPassword = document.getElementById('toggleCurrentPassword');
    const toggleNewPassword = document.getElementById('toggleNewPassword');
    const strengthBar = document.getElementById('strengthBar');
    const passwordHints = document.getElementById('passwordHints');
    const lengthHint = document.getElementById('lengthHint');
    const complexityHint = document.getElementById('complexityHint');
    const currentPasswordGroup = document.getElementById('currentPasswordGroup');
    const newPasswordGroup = document.getElementById('newPasswordGroup');

    // Toggle password visibility
    function setupPasswordToggle(toggleElement, inputElement) {
      toggleElement.addEventListener('click', () => {
        const isPassword = inputElement.type === 'password';
        inputElement.type = isPassword ? 'text' : 'password';
        toggleElement.classList.toggle('mdi-eye-off', isPassword);
        toggleElement.classList.toggle('mdi-eye', !isPassword);
      });
    }

    setupPasswordToggle(toggleCurrentPassword, currentPasswordInput);
    setupPasswordToggle(toggleNewPassword, newPasswordInput);

    // Password strength indicator
    newPasswordInput.addEventListener('input', function() {
      const password = this.value;
      if (password.length === 0) {
        strengthBar.className = 'strength-bar';
        passwordHints.classList.remove('show');
        return;
      }
      
      passwordHints.classList.add('show');
      
      // Check password length
      const hasMinLength = password.length >= 6;
      lengthHint.className = `hint-item ${hasMinLength ? 'hint-valid' : 'hint-invalid'}`;
      lengthHint.querySelector('.mdi').className = `mdi ${hasMinLength ? 'mdi-check-circle' : 'mdi-checkbox-blank-circle-outline'}`;
      
      // Check password complexity
      const hasComplexity = /[0-9!@#$%^&*]/.test(password);
      complexityHint.className = `hint-item ${hasComplexity ? 'hint-valid' : 'hint-invalid'}`;
      complexityHint.querySelector('.mdi').className = `mdi ${hasComplexity ? 'mdi-check-circle' : 'mdi-checkbox-blank-circle-outline'}`;
      
      // Update strength bar
      if (password.length < 6) {
        strengthBar.className = 'strength-bar';
      } else if (password.length < 8 || !hasComplexity) {
        strengthBar.className = 'strength-bar strength-weak';
      } else if (password.length < 10) {
        strengthBar.className = 'strength-bar strength-medium';
      } else {
        strengthBar.className = 'strength-bar strength-strong';
      }
    });

    // Check auth state
    auth.onAuthStateChanged((user) => {
      if (!user) {
        showAuthWarning();
      } else {
        loadUserData(user.uid);
        handlePasswordFields(user);
      }
    });

    // Handle password fields based on provider
    function handlePasswordFields(user) {
      const providerData = user.providerData;
      const isEmailProvider = providerData.some(
        (provider) => provider.providerId === 'password'
      );

      if (!isEmailProvider) {
        // Disable password fields for Google/Facebook users
        currentPasswordGroup.classList.add('disabled');
        newPasswordGroup.classList.add('disabled');
        currentPasswordInput.disabled = true;
        newPasswordInput.disabled = true;
      }
    }

    // Show auth warning
    function showAuthWarning() {
      Swal.fire({
        title: 'ورود لازم است',
        text: 'لطفاً ابتدا وارد حساب کاربری خود شوید',
        icon: 'warning',
        confirmButtonText: 'ورود',
        confirmButtonColor: 'var(--primary)',
        background: 'var(--bg-white)',
        allowOutsideClick: false
      }).then(() => {
        window.location.href = 'login.html';
      });
    }

    // Load user data
    function loadUserData(userId) {
      const userRef = database.ref('users/' + userId);
      
      userRef.once('value')
        .then((snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            
            // Fill form with user data
            if (userData.fullname) fullnameInput.value = userData.fullname;
            if (userData.phone) phoneInput.value = userData.phone;
            
            // Set profile photo
            if (userData.profilePhoto) {
              profilePhoto.src = userData.profilePhoto;
            } else {
              // Generate initials avatar if no photo exists
              const initials = userData.fullname ? 
                userData.fullname.split(' ').map(n => n[0]).join('').toUpperCase() : 'JP';
              profilePhoto.src = `https://via.placeholder.com/120/7b1fa2/ffffff?text=${initials}`;
            }
          } else {
            // Create initial user record if doesn't exist
            userRef.set({
              fullname: '',
              phone: '',
              profilePhoto: '',
              lastUpdated: new Date().toISOString()
            });
          }
        })
        .catch((error) => {
          console.error('Error loading user data:', error);
          showError('خطا در دریافت اطلاعات نمایه');
        });
    }

    // Convert image to Base64 with compression
    function compressAndConvertToBase64(file, maxWidth = 400, quality = 0.8) {
      return new Promise((resolve, reject) => {
        if (!file.type.match('image.*')) {
          reject(new Error('File is not an image'));
          return;
        }

        const reader = new FileReader();
        reader.onload = (readerEvent) => {
          const image = new Image();
          image.onload = () => {
            const canvas = document.createElement('canvas');
            let width = image.width;
            let height = image.height;

            if (width > maxWidth) {
              height *= maxWidth / width;
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(image, 0, 0, width, height);
            
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          image.src = readerEvent.target.result;
        };
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    // Handle profile photo upload
    photoInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file
      if (file.size > 5 * 1024 * 1024) {
        showError('حجم عکس باید کمتر از 5 مگابایت باشد');
        return;
      }

      try {
        // Compress and convert image
        const base64Image = await compressAndConvertToBase64(file);
        
        // Save to database
        const userId = auth.currentUser.uid;
        await database.ref('users/' + userId).update({
          profilePhoto: base64Image,
          lastUpdated: new Date().toISOString()
        });
        
        // Update profile photo
        profilePhoto.src = base64Image;
        
        showSuccess('عکس نمایه با موفقیت ذخیره شد');
      } catch (error) {
        console.error('Error saving photo:', error);
        showError('خطا در ذخیره عکس نمایه');
      }
    });

    // Form validation
    function validateForm() {
      // Validate password if changed
      if (newPasswordInput.value && !newPasswordInput.disabled) {
        if (newPasswordInput.value.length < 6) {
          showError('رمز عبور جدید باید حداقل ۶ کاراکتر باشد');
          return false;
        }
        
        if (!currentPasswordInput.value) {
          showError('برای تغییر رمز، رمز عبور فعلی را وارد کنید');
          return false;
        }
      }

      // Validate phone number format
      if (phoneInput.value && !/^\+93[0-9]{9}$/.test(phoneInput.value)) {
        showError('شماره تلفن معتبر نیست (باید با +93 شروع شود و 12 رقم داشته باشد)');
        return false;
      }

      return true;
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!validateForm()) return;

      const user = auth.currentUser;
      if (!user) return;

      try {
        // Prepare updates
        const updates = {
          fullname: fullnameInput.value.trim(),
          phone: phoneInput.value.trim(),
          lastUpdated: new Date().toISOString()
        };

        // Update database
        await database.ref(`users/${user.uid}`).update(updates);

        // Update password if changed and allowed
        if (newPasswordInput.value && !newPasswordInput.disabled) {
          const providerData = user.providerData;
          const isEmailProvider = providerData.some(
            (provider) => provider.providerId === 'password'
          );

          if (isEmailProvider) {
            const credential = firebase.auth.EmailAuthProvider.credential(
              user.email,
              currentPasswordInput.value
            );
            
            await user.reauthenticateWithCredential(credential);
            await user.updatePassword(newPasswordInput.value);
            showSuccess('رمز عبور با موفقیت تغییر کرد');
          } else {
            showError('تغییر رمز عبور برای حساب‌های گوگل یا فیسبوک امکان‌پذیر نیست');
            return;
          }
        }

        showSuccess('تغییرات با موفقیت ذخیره شد');
        currentPasswordInput.value = '';
        newPasswordInput.value = '';
      } catch (error) {
        console.error('Error saving changes:', error);
        
        // Handle specific errors
        let errorMessage = 'خطا در ذخیره تغییرات';
        switch (error.code) {
          case 'auth/wrong-password':
            errorMessage = 'رمز عبور فعلی نادرست است';
            break;
          case 'auth/weak-password':
            errorMessage = 'رمز عبور جدید بسیار ضعیف است';
            break;
          case 'auth/requires-recent-login':
            errorMessage = 'برای تغییر رمز عبور، لطفاً دوباره وارد شوید';
            break;
          case 'auth/invalid-credential':
            errorMessage = 'اعتبارسنجی ناموفق بود';
            break;
        }
        
        showError(errorMessage);
      }
    });

    // Cancel button
    cancelBtn.addEventListener('click', () => {
      Swal.fire({
        title: 'انصراف از تغییرات',
        text: 'آیا مطمئن هستید میخواهید از ذخیره تغییرات انصراف دهید؟',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'بله، انصراف',
        cancelButtonText: 'خیر، ادامه ویرایش',
        confirmButtonColor: 'var(--primary)',
        background: 'var(--bg-white)'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = 'profile.html';
        }
      });
    });

    // Helper functions for notifications
    function showError(message) {
      Swal.fire({
        title: 'خطا',
        text: message,
        icon: 'error',
        confirmButtonText: 'متوجه شدم',
        confirmButtonColor: 'var(--primary)',
        background: 'var(--bg-white)'
      });
    }

    function showSuccess(message) {
      Swal.fire({
        title: 'موفقیت',
        text: message,
        icon: 'success',
        confirmButtonText: 'درست است',
        confirmButtonColor: 'var(--primary)',
        background: 'var(--bg-white)'
      });
    }
  </script>

</body>
</html>
8.2s
وقتی میخواهیم شماره و نام را ذخیره کنم در حالیکه با گوگل و فیسبوک وارد شدیم باز هم خطا در ذخیره تغییرات نمایش داده میشود علت چیست

خطای "خطا در ذخیره تغییرات" که هنگام ذخیره نام و شماره تلفن برای کاربرانی که با گوگل یا فیسبوک وارد شده‌اند نمایش داده می‌شود، ممکن است به دلایل مختلفی رخ دهد. با توجه به کد ارائه‌شده و درخواست شما، مشکل احتمالاً به نحوه مدیریت احراز هویت یا فرآیند ذخیره‌سازی داده‌ها در Firebase مربوط است. در ادامه، دلایل احتمالی این خطا و راه‌حل‌های مربوطه را بررسی می‌کنم و کد اصلاح‌شده را ارائه می‌دهم.
علل احتمالی خطا

    مشکل در احراز هویت کاربر:
        اگرچه کد شما بررسی می‌کند که کاربر وارد شده است (auth.currentUser)، ممکن است در برخی موارد به دلیل مشکلات همگام‌سازی یا عدم وجود کاربر در حالت فعلی، خطا رخ دهد.
        اگر کاربر به‌تازگی وارد شده باشد و جلسه (session) احراز هویت منقضی شده باشد، Firebase ممکن است نتواند به درستی به پایگاه داده دسترسی پیدا کند.
    خطا در دسترسی به پایگاه داده Firebase:
        ممکن است قوانین امنیتی (Firebase Security Rules) در پایگاه داده شما به‌گونه‌ای تنظیم شده باشد که اجازه نوشتن داده‌ها را برای کاربران خاص محدود کند.
        اگر مسیر users/${user.uid} به درستی تنظیم نشده باشد یا دسترسی به آن محدود باشد، عملیات به‌روزرسانی ناموفق خواهد بود.
    مدیریت نادرست خطاها در کد:
        بخش مدیریت خطاها (catch) در کد شما عمومی است و خطاهای خاص مربوط به پایگاه داده (مانند permission-denied) را به‌صورت دقیق شناسایی نمی‌کند، بنابراین پیام خطای عمومی "خطا در ذخیره تغییرات" نمایش داده می‌شود.
    ناسازگاری در داده‌ها:
        اگر کاربر با گوگل یا فیسبوک وارد شده باشد و حساب کاربری در پایگاه داده به درستی ایجاد نشده باشد (مثلاً به دلیل خطا در loadUserData)، عملیات به‌روزرسانی ممکن است با شکست مواجه شود.
    مشکلات مربوط به ساختار پایگاه داده:
        اگر ساختار داده‌ها در پایگاه داده (مانند کلیدهای fullname یا phone) با کد همخوانی نداشته باشد یا داده‌ها به‌درستی ذخیره نشده باشند، خطا رخ می‌دهد.

راه‌حل‌های پیشنهادی

برای رفع این مشکل، باید اطمینان حاصل کنیم که:

    احراز هویت کاربر به درستی انجام می‌شود.
    قوانین پایگاه داده اجازه نوشتن و خواندن داده‌ها را برای کاربران احراز هویت‌شده می‌دهند.
    خطاهای خاص به‌درستی شناسایی و به کاربر نمایش داده می‌شوند.
    فرآیند ذخیره‌سازی نام و شماره تلفن برای همه کاربران (گوگل، فیسبوک، یا ایمیل/رمز عبور) به درستی کار می‌کند.

مرحله ۱: بررسی قوانین پایگاه داده Firebase

اطمینان حاصل کنید که قوانین پایگاه داده (Realtime Database Security Rules) اجازه دسترسی به مسیر users/${user.uid} را برای کاربران احراز هویت‌شده می‌دهند. قوانین پیشنهادی:
json
{
  "rules": {
    "users": {
      "$uid": {
        ".read": "auth != null && auth.uid == $uid",
        ".write": "auth != null && auth.uid == $uid"
      }
    }
  }
}

این قوانین تضمین می‌کنند که فقط کاربر احراز هویت‌شده می‌تواند داده‌های مربوط به خودش را بخواند یا بنویسد. این قوانین را در کنسول Firebase (بخش Database > Rules) تنظیم کنید.
مرحله ۲: بهبود مدیریت خطاها

در بخش try/catch کد، خطاهای خاص مربوط به پایگاه داده (مانند permission-denied) را شناسایی و پیام‌های خطای مناسب‌تری نمایش دهید.
مرحله ۳: اطمینان از ایجاد رکورد کاربر

در تابع loadUserData， اطمینان حاصل کنید که اگر رکورد کاربر وجود ندارد، به درستی ایجاد می‌شود و داده‌های اولیه به‌درستی تنظیم می‌شوند.
مرحله ۴: جدا کردن ذخیره‌سازی نام/شماره از تغییر رمز عبور

از آنجا که تغییر رمز عبور فقط برای کاربران ایمیل/رمز عبور مجاز است، باید اطمینان حاصل کنیم که ذخیره‌سازی نام و شماره تلفن به‌صورت مستقل و بدون وابستگی به فرآیند تغییر رمز عبور انجام می‌شود.
کد اصلاح‌شده

در کد زیر، تغییرات لازم برای رفع مشکل ذخیره‌سازی نام و شماره تلفن برای کاربران گوگل و فیسبوک اعمال شده است. همچنین، مدیریت خطاها بهبود یافته و اطمینان حاصل شده که فیلدهای رمز عبور برای کاربران گوگل و فیسبوک غیرفعال باقی می‌مانند.
html
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ویرایش پروفایل - Josh</title>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font/dist/font-face.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" />
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --primary: #7b1fa2;
      --primary-dark: #4a148c;
      --primary-light: #9c27b0;
      --secondary: #d81b60;
      --secondary-dark: #b71c1c;
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --bg-light: #f8f9fa;
      --
14.2s
Interrupted
{
  "rules": {
    ".read": "auth != null && auth.token.email === 'walizadamamoon@gmail.com'",
    ".write": "auth != null && auth.token.email === 'walizadamamoon@gmail.com'",
    
    "users": {
      "$user_id": {
        ".read": "auth != null && (auth.uid === $user_id || auth.token.email === 'walizadamamoon@gmail.com')",
        ".write": "auth != null && (auth.uid === $user_id || auth.token.email === 'walizadamamoon@gmail.com')",
        
        "fullname": {
          ".validate": "newData.isString() && newData.val().length <= 100"
        },
        "phone": {
          ".validate": "newData.isString() && (newData.val().matches(/^\\+93[0-9]{9}$/) || newData.val().length === 0)"
        },
        "profilePhoto": {
          ".validate": "newData.isString()"
        },
        "lastUpdated": {
          ".validate": "newData.isNumber()"
        }
      }
    },
    
    "fcricket_match4": {
      "$user_id": {
        ".read": "auth != null && (auth.uid === $user_id || auth.token.email === 'walizadamamoon@gmail.com')",
        ".write": "auth != null && (auth.uid === $user_id || auth.token.email === 'walizadamamoon@gmail.com')",
        
        "players": {
          ".validate": "newData.isString() || newData.hasChildren()"
        },
        "captain": {
          ".validate": "newData.isString()"
        },
        "viceCaptain": {
          ".validate": "newData.isString()"
        },
        "userInfo": {
          "uid": {
            ".validate": "newData.isString() && newData.val() === auth.uid"
          },
          "email": {
            ".validate": "newData.isString()"
          }
        }
      }
    }
  }
}

این قانون real time database است

با تشکر از ارائه قوانین پایگاه داده Realtime Database در Firebase. مشکل "خطا در ذخیره تغییرات" که هنگام ذخیره نام و شماره تلفن برای کاربرانی که با گوگل یا فیسبوک وارد شده‌اند رخ می‌دهد، به احتمال زیاد به دلیل قوانین امنیتی سخت‌گیرانه در پایگاه داده یا عدم تطابق منطق کد با این قوانین است. در ادامه، قوانین پایگاه داده را تحلیل می‌کنم، دلایل احتمالی خطا را توضیح می‌دهم و کد اصلاح‌شده‌ای ارائه می‌کنم که با این قوانین سازگار باشد و درخواست شما را (ذخیره نام و شماره تلفن برای همه کاربران و محدود کردن تغییر رمز عبور به کاربران ایمیل/رمز عبور) به‌طور کامل برآورده کند.
تحلیل قوانین پایگاه داده

قوانین پایگاه داده شما به‌گونه‌ای تنظیم شده‌اند که:

    دسترسی کلی:
        فقط کاربری با ایمیل walizadamamoon@gmail.com می‌تواند به‌صورت کلی به پایگاه داده خواندن و نوشتن کند (به دلیل قوانین .read و .write در سطح ریشه).
        این قانون بسیار محدودکننده است و برای اکثر کاربران (حتی کاربران احراز هویت‌شده) دسترسی به پایگاه داده را غیرممکن می‌کند، مگر اینکه ایمیل آن‌ها walizadamamoon@gmail.com باشد.
    دسترسی به مسیر users/$user_id:
        کاربران احراز هویت‌شده می‌توانند به داده‌های خود در مسیر users/$user_id دسترسی داشته باشند، به شرطی که auth.uid === $user_id یا ایمیل آن‌ها walizadamamoon@gmail.com باشد.
        این قانون اجازه می‌دهد که کاربران به داده‌های خود (مانند fullname و phone) دسترسی داشته باشند و آن‌ها را ویرایش کنند.
    اعتبارسنجی داده‌ها:
        فیلد fullname باید یک رشته با حداکثر 100 کاراکتر باشد.
        فیلد phone باید یک رشته باشد که با الگوی +93 شروع شده و 9 رقم بعد از آن داشته باشد، یا خالی باشد.
        فیلد profilePhoto باید یک رشته باشد.
        فیلد lastUpdated باید یک عدد باشد (این ممکن است مشکل ایجاد کند، زیرا در کد شما از new Date().toISOString() استفاده شده که یک رشته است).
    مشکلات احتمالی در قوانین:
        قانون ریشه محدودکننده: قوانین .read و .write در سطح ریشه فقط به ایمیل walizadamamoon@gmail.com اجازه دسترسی می‌دهند. این ممکن است باعث شود که عملیات خواندن/نوشتن برای کاربران دیگر (حتی اگر در مسیر users/$user_id مجاز باشند) با خطای permission-denied مواجه شود.
        عدم تطابق نوع داده lastUpdated: در کد شما، lastUpdated به‌صورت new Date().toISOString() (یک رشته) ذخیره می‌شود، اما قانون پایگاه داده انتظار یک عدد دارد. این باعث خطای اعتبارسنجی می‌شود.
        پیچیدگی قوانین: قوانین فعلی ممکن است به‌طور ناخواسته دسترسی کاربران را محدود کنند، به‌خصوص اگر فرآیند احراز هویت یا مسیرهای پایگاه داده به‌درستی مدیریت نشوند.

علت خطا در ذخیره تغییرات

با توجه به قوانین پایگاه داده و کد ارائه‌شده، دلایل احتمالی خطای "خطا در ذخیره تغییرات" عبارتند از:

    خطای اعتبارسنجی lastUpdated:
        در کد شما، مقدار lastUpdated به‌صورت رشته (new Date().toISOString()) ذخیره می‌شود، اما قانون پایگاه داده (".validate": "newData.isNumber()") انتظار یک عدد دارد. این باعث خطای اعتبارسنجی می‌شود و عملیات به‌روزرسانی ناموفق خواهد بود.
    قوانین ریشه محدودکننده:
        قوانین ریشه (.read و .write) ممکن است باعث شوند که حتی کاربران احراز هویت‌شده با خطای permission-denied مواجه شوند، زیرا ایمیل آن‌ها walizadamamoon@gmail.com نیست.
    مدیریت ناکافی خطاها:
        کد فعلی شما خطاهای خاص پایگاه داده (مانند permission-denied یا خطاهای اعتبارسنجی) را به‌طور دقیق شناسایی نمی‌کند و فقط پیام عمومی "خطا در ذخیره تغییرات" را نمایش می‌دهد.

راه‌حل‌ها

برای رفع مشکل و اطمینان از اینکه:

    همه کاربران (چه با گوگل، فیسبوک یا ایمیل/رمز عبور) بتوانند نام و شماره تلفن خود را ذخیره و بازیابی کنند.
    فقط کاربران ایمیل/رمز عبور بتوانند رمز عبور خود را تغییر دهند.
    خطاها به‌درستی مدیریت شوند، تغییرات زیر را اعمال می‌کنیم:

مرحله ۱: اصلاح قوانین پایگاه داده

قوانین پایگاه داده باید اصلاح شوند تا:

    قانون lastUpdated با نوع داده رشته سازگار باشد.
    قوانین ریشه کمتر محدودکننده باشند تا کاربران احراز هویت‌شده بتوانند به مسیرهای مجاز دسترسی داشته باشند.

قوانین اصلاح‌شده:
json
{
  "rules": {
    "users": {
      "$user_id": {
        ".read": "auth != null && (auth.uid === $user_id || auth.token.email === 'walizadamamoon@gmail.com')",
        ".write": "auth != null && (auth.uid === $user_id || auth.token.email === 'walizadamamoon@gmail.com')",
        "fullname": {
          ".validate": "newData.isString() && newData.val().length <= 100"
        },
        "phone": {
          ".validate": "newData.isString() && (newData.val().matches(/^\\+93[0-9]{9}$/) || newData.val().length === 0)"
        },
        "profilePhoto": {
          ".validate": "newData.isString()"
        },
        "lastUpdated": {
          ".validate": "newData.isString()" // تغییر به رشته برای سازگاری با toISOString
        }
      }
    },
    "fcricket_match4": {
      "$user_id": {
        ".read": "auth != null && (auth.uid === $user_id || auth.token.email === 'walizadamamoon@gmail.com')",
        ".write": "auth != null && (auth.uid === $user_id || auth.token.email === 'walizadamamoon@gmail.com')",
        "players": {
          ".validate": "newData.isString() || newData.hasChildren()"
        },
        "captain": {
          ".validate": "newData.isString()"
        },
        "viceCaptain": {
          ".validate": "newData.isString()"
        },
        "userInfo": {
          "uid": {
            ".validate": "newData.isString() && newData.val() === auth.uid"
          },
          "email": {
            ".validate": "newData.isString()"
          }
        }
      }
    }
  }
}

تغییرات در قوانین:

    قوانین ریشه (.read و .write) حذف شده‌اند تا از محدود شدن دسترسی کاربران جلوگیری شود.
    قانون lastUpdated به newData.isString() تغییر کرده تا با مقدار toISOString() سازگار باشد.

مرحله ۲: اصلاح کد برای مدیریت بهتر خطاها

باید خطاهای خاص پایگاه داده (مانند permission-denied) را شناسایی کنیم و پیام‌های خطای دقیق‌تری به کاربر نمایش دهیم.
مرحله ۳: اطمینان از ذخیره‌سازی نام و شماره تلفن

کد باید اطمینان دهد که ذخیره‌سازی نام و شماره تلفن برای همه کاربران (گوگل، فیسبوک، ایمیل/رمز عبور) به درستی انجام می‌شود و فقط کاربران ایمیل/رمز عبور بتوانند فیلدهای رمز عبور را مشاهده و ویرایش کنند.
کد اصلاح‌شده

کد زیر مشکلات مربوط به ذخیره‌سازی نام و شماره تلفن را برطرف می‌کند، فیلدهای رمز عبور را برای کاربران گوگل و فیسبوک غیرفعال نگه می‌دارد و مدیریت خطاها را بهبود می‌بخشد:
html
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ویرایش پروفایل - Josh</title>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font/dist/font-face.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" />
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --primary: #7b1fa2;
      --primary-dark: #4a148c;
      --primary-light: #9c27b0;
      --secondary: #d81b60;
      --secondary-dark: #b71c1c;
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --bg-light: #f8f9fa;
      --bg-white: #ffffff;
      --border-light: #e2e8f0;
      --error: #e53e3e;
      --success: #38a169;
      --warning: #dd6b20;
      --radius-md: 12px;
      --radius-lg: 16px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Vazir, Tahoma, sans-serif;
      background: var(--bg-light);
      color: var(--text-primary);
      padding: 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .profile-container {
      width: 100%;
      max-width: 500px;
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      padding: 32px 24px;
      box-shadow: var(--shadow-lg);
      position: relative;
      border: 1px solid var(--border-light);
    }

    h2 {
      margin-bottom: 24px;
      font-weight: 800;
      font-size: 1.5rem;
      color: var(--primary-dark);
      text-align: center;
      position: relative;
      padding-bottom: 12px;
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: 50%;
      transform: translateX(50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      border-radius: 3px;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    label {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .required::after {
      content: '*';
      color: var(--error);
      font-size: 0.8rem;
      margin-right: 4px;
    }

    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    input[type="text"],
    input[type="password"],
    input[type="tel"] {
      width: 100%;
      padding: 12px 16px 12px 40px;
      font-size: 0.95rem;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      outline: none;
      transition: var(--transition);
      background-color: var(--bg-white);
      color: var(--text-primary);
    }

    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(123, 31, 162, 0.2);
    }

    .input-icon {
      position: absolute;
      right: 1px;
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    .btn-group {
      margin-top: 24px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      font-family: Vazir, Tahoma, sans-serif;
      font-weight: 600;
      border: none;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      min-width: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: var(--bg-white);
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .btn-secondary:hover {
      background: rgba(123, 31, 162, 0.05);
      border-color: var(--primary-dark);
    }

    .message {
      margin-top: 16px;
      font-size: 0.9rem;
      min-height: 20px;
      text-align: center;
    }

    .profile-photo-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 24px;
      position: relative;
    }

    .profile-photo-wrapper {
      position: relative;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      padding: 4px;
      box-shadow: var(--shadow-md);
    }

    #profilePhoto {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
      background-color: #f9f0f0;
    }

    .photo-upload-btn {
      margin-top: 12px;
      background: var(--bg-white);
      color: var(--primary);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .photo-upload-btn:hover {
      background: rgba(123, 31, 162, 0.05);
      border-color: var(--primary);
    }

    #photoInput {
      display: none;
    }

    .optional-field {
      color: var(--text-secondary);
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .password-toggle {
      position: absolute;
      left: 12px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    @media (max-width: 480px) {
      .profile-container {
        padding: 24px 16px;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
      }
    }

    .password-strength {
      margin-top: 4px;
      height: 4px;
      border-radius: 2px;
      background: #e2e8f0;
      overflow: hidden;
    }

    .strength-bar {
      height: 100%;
      width: 0%;
      transition: var(--transition);
    }

    .strength-weak {
      background: var(--error);
      width: 33%;
    }

    .strength-medium {
      background: var(--warning);
      width: 66%;
    }

    .strength-strong {
      background: var(--success);
      width: 100%;
    }

    .password-hints {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 4px;
      display: none;
    }

    .password-hints.show {
      display: block;
    }

    .hint-item {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }

    .hint-valid {
      color: var(--success);
    }

    .hint-invalid {
      color: var(--text-secondary);
    }

    .form-group.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .form-group.disabled label {
      color: var(--text-secondary);
    }

    .form-group.disabled input {
      background-color: var(--bg-light);
      border-color: var(--border-light);
    }
  </style>
</head>
<body>

  <div class="profile-container">
    <h2>ویرایش نمایه</h2>

    <div class="profile-photo-container">
      <div class="profile-photo-wrapper">
        <img id="profilePhoto" src="https://via.placeholder.com/120?text=JP" alt="عکس نمایه" />
      </div>
      <label for="photoInput" class="photo-upload-btn">
        <span class="mdi mdi-camera"></span>
        تغییر عکس نمایه
      </label>
      <input type="file" id="photoInput" accept="image/*" capture="user" />
    </div>

    <form id="profileForm" autocomplete="off">
      <div class="form-group">
        <label for="fullname">نام کامل</label>
        <div class="input-wrapper">
          <span class="input-icon mdi mdi-account"></span>
          <input type="text" id="fullname" name="fullname" placeholder="نام و نام خانوادگی" />
        </div>
      </div>

      <div class="form-group">
        <label for="phone">شماره تلفن</label>
        <div class="input-wrapper">
          <span class="input-icon mdi mdi-phone"></span>
          <input type="tel" id="phone" name="phone" placeholder="+93XXXXXXXXX" dir="ltr" />
        </div>
      </div>

      <div class="form-group password-group" id="currentPasswordGroup">
        <label for="currentPassword">رمز عبور فعلی <span class="optional-field">(برای تغییر رمز)</span></label>
        <div class="input-wrapper">
          <span class="password-toggle mdi mdi-eye-off" id="toggleCurrentPassword"></span>
          <input type="password" id="currentPassword" name="currentPassword" placeholder="رمز عبور فعلی" />
        </div>
      </div>

      <div class="form-group password-group" id="newPasswordGroup">
        <label for="newPassword">رمز عبور جدید <span class="optional-field">(اختیاری)</span></label>
        <div class="input-wrapper">
          <span class="password-toggle mdi mdi-eye-off" id="toggleNewPassword"></span>
          <input type="password" id="newPassword" name="newPassword" placeholder="رمز عبور جدید (حداقل ۶ کاراکتر)" />
        </div>
        <div class="password-strength">
          <div class="strength-bar" id="strengthBar"></div>
        </div>
        <div class="password-hints" id="passwordHints">
          <div class="hint-item" id="lengthHint">
            <span class="mdi mdi-checkbox-blank-circle-outline"></span>
            حداقل ۶ کاراکتر
          </div>
          <div class="hint-item" id="complexityHint">
            <span class="mdi mdi-checkbox-blank-circle-outline"></span>
            شامل اعداد یا نمادها
          </div>
        </div>
      </div>

      <div class="btn-group">
        <button type="submit" class="btn-primary">
          <span class="mdi mdi-content-save"></span>
          ذخیره تغییرات
        </button>
        <button type="button" id="cancelBtn" class="btn-secondary">
          <span class="mdi mdi-close"></span>
          انصراف
        </button>
      </div>
    </form>
  </div>

  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDLfUbSG30O474XPAPY8QpMzo19EMfLWFc",
      authDomain: "josh-7b6a0.firebaseapp.com",
      databaseURL: "https://josh-7b6a0-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "josh-7b6a0",
      storageBucket: "josh-7b6a0.appspot.com",
      messagingSenderId: "639816255525",
      appId: "1:639816255525:web:71a3e87374c3e7c68e17cc",
      measurementId: "G-P2ZSBTN8FP"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // DOM elements
    const fullnameInput = document.getElementById('fullname');
    const phoneInput = document.getElementById('phone');
    const currentPasswordInput = document.getElementById('currentPassword');
    const newPasswordInput = document.getElementById('newPassword');
    const profilePhoto = document.getElementById('profilePhoto');
    const photoInput = document.getElementById('photoInput');
    const form = document.getElementById('profileForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const toggleCurrentPassword = document.getElementById('toggleCurrentPassword');
    const toggleNewPassword = document.getElementById('toggleNewPassword');
    const strengthBar = document.getElementById('strengthBar');
    const passwordHints = document.getElementById('passwordHints');
    const lengthHint = document.getElementById('lengthHint');
    const complexityHint = document.getElementById('complexityHint');
    const currentPasswordGroup = document.getElementById('currentPasswordGroup');
    const newPasswordGroup = document.getElementById('newPasswordGroup');

    // Toggle password visibility
    function setupPasswordToggle(toggleElement, inputElement) {
      toggleElement.addEventListener('click', () => {
        const isPassword = inputElement.type === 'password';
        inputElement.type = isPassword ? 'text' : 'password';
        toggleElement.classList.toggle('mdi-eye-off', isPassword);
        toggleElement.classList.toggle('mdi-eye', !isPassword);
      });
    }

    setupPasswordToggle(toggleCurrentPassword, currentPasswordInput);
    setupPasswordToggle(toggleNewPassword, newPasswordInput);

    // Password strength indicator
    newPasswordInput.addEventListener('input', function() {
      const password = this.value;
      if (password.length === 0) {
        strengthBar.className = 'strength-bar';
        passwordHints.classList.remove('show');
        return;
      }
      
      passwordHints.classList.add('show');
      
      const hasMinLength = password.length >= 6;
      lengthHint.className = `hint-item ${hasMinLength ? 'hint-valid' : 'hint-invalid'}`;
      lengthHint.querySelector('.mdi').className = `mdi ${hasMinLength ? 'mdi-check-circle' : 'mdi-checkbox-blank-circle-outline'}`;
      
      const hasComplexity = /[0-9!@#$%^&*]/.test(password);
      complexityHint.className = `hint-item ${hasComplexity ? 'hint-valid' : 'hint-invalid'}`;
      complexityHint.querySelector('.mdi').className = `mdi ${hasComplexity ? 'mdi-check-circle' : 'mdi-checkbox-blank-circle-outline'}`;
      
      if (password.length < 6) {
        strengthBar.className = 'strength-bar';
      } else if (password.length < 8 || !hasComplexity) {
        strengthBar.className = 'strength-bar strength-weak';
      } else if (password.length < 10) {
        strengthBar.className = 'strength-bar strength-medium';
      } else {
        strengthBar.className = 'strength-bar strength-strong';
      }
    });

    // Check auth state
    auth.onAuthStateChanged((user) => {
      if (!user) {
        showAuthWarning();
      } else {
        loadUserData(user.uid);
        handlePasswordFields(user);
      }
    });

    // Handle password fields based on provider
    function handlePasswordFields(user) {
      const providerData = user.providerData;
      const isEmailProvider = providerData.some(
        (provider) => provider.providerId === 'password'
      );

      if (!isEmailProvider) {
        currentPasswordGroup.classList.add('disabled');
        newPasswordGroup.classList.add('disabled');
        currentPasswordInput.disabled = true;
        newPasswordInput.disabled = true;
      }
    }

    // Show auth warning
    function showAuthWarning() {
      Swal.fire({
        title: 'ورود لازم است',
        text: 'لطفاً ابتدا وارد حساب کاربری خود شوید',
        icon: 'warning',
        confirmButtonText: 'ورود',
        confirmButtonColor: 'var(--primary)',
        background: 'var(--bg-white)',
        allowOutsideClick: false
      }).then(() => {
        window.location.href = 'login.html';
      });
    }

    // Load user data
    function loadUserData(userId) {
      const userRef = database.ref('users/' + userId);
      
      userRef.once('value')
        .then((snapshot) => {
          if (snapshot.exists()) {
            const userData = snapshot.val();
            if (userData.fullname) fullnameInput.value = userData.fullname;
            if (userData.phone) phoneInput.value = userData.phone;
            if (userData.profilePhoto) {
              profilePhoto.src = userData.profilePhoto;
            } else {
              const initials = userData.fullname ? 
                userData.fullname.split(' ').map(n => n[0]).join('').toUpperCase() : 'JP';
              profilePhoto.src = `https://via.placeholder.com/120/7b1fa2/ffffff?text=${initials}`;
            }
          } else {
            userRef.set({
              fullname: '',
              phone: '',
              profilePhoto: '',
              lastUpdated: new Date().toISOString()
            }).catch((error) => {
              console.error('Error creating user record:', error);
              showError('خطا در ایجاد پروفایل کاربر: ' + getErrorMessage(error));
            });
          }
        })
        .catch((error) => {
          console.error('Error loading user data:', error);
          showError('خطا در دریافت اطلاعات نمایه: ' + getErrorMessage(error));
        });
    }

    // Convert image to Base64 with compression
    function compressAndConvertToBase64(file, maxWidth = 400, quality = 0.8) {
      return new Promise((resolve, reject) => {
        if (!file.type.match('image.*')) {
          reject(new Error('File is not an image'));
          return;
        }

        const reader = new FileReader();
        reader.onload = (readerEvent) => {
          const image = new Image();
          image.onload = () => {
            const canvas = document.createElement('canvas');
            let width = image.width;
            let height = image.height;

            if (width > maxWidth) {
              height *= maxWidth / width;
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(image, 0, 0, width, height);
            
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          image.src = readerEvent.target.result;
        };
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    // Handle profile photo upload
    photoInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        showError('حجم عکس باید کمتر از 5 مگابایت باشد');
        return;
      }

      try {
        const base64Image = await compressAndConvertToBase64(file);
        const userId = auth.currentUser.uid;
        await database.ref('users/' + userId).update({
          profilePhoto: base64Image,
          lastUpdated: new Date().toISOString()
        });
        profilePhoto.src = base64Image;
        showSuccess('عکس نمایه با موفقیت ذخیره شد');
      } catch (error) {
        console.error('Error saving photo:', error);
        showError('خطا در ذخیره عکس نمایه: ' + getErrorMessage(error));
      }
    });

    // Form validation
    function validateForm() {
      if (newPasswordInput.value && !newPasswordInput.disabled) {
        if (newPasswordInput.value.length < 6) {
          showError('رمز عبور جدید باید حداقل ۶ کاراکتر باشد');
          return false;
        }
        if (!currentPasswordInput.value) {
          showError('برای تغییر رمز، رمز عبور فعلی را وارد کنید');
          return false;
        }
      }

      if (phoneInput.value && !/^\+93[0-9]{9}$/.test(phoneInput.value)) {
        showError('شماره تلفن معتبر نیست (باید با +93 شروع شود و 12 رقم داشته باشد)');
        return false;
      }

      if (fullnameInput.value.length > 100) {
        showError('نام کامل نمی‌تواند بیشتر از 100 کاراکتر باشد');
        return false;
      }

      return true;
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!validateForm()) return;

      const user = auth.currentUser;
      if (!user) {
        showError('کاربر وارد نشده است. لطفاً دوباره وارد شوید.');
        return;
      }

      try {
        const updates = {
          fullname: fullnameInput.value.trim(),
          phone: phoneInput.value.trim(),
          lastUpdated: new Date().toISOString()
        };

        await database.ref(`users/${user.uid}`).update(updates);

        if (newPasswordInput.value && !newPasswordInput.disabled) {
          const providerData = user.providerData;
          const isEmailProvider = providerData.some(
            (provider) => provider.providerId === 'password'
          );

          if (isEmailProvider) {
            const credential = firebase.auth.EmailAuthProvider.credential(
              user.email,
              currentPasswordInput.value
            );
            await user.reauthenticateWithCredential(credential);
            await user.updatePassword(newPasswordInput.value);
            showSuccess('رمز عبور و اطلاعات با موفقیت ذخیره شد');
          } else {
            showError('تغییر رمز عبور برای حساب‌های گوگل یا فیسبوک امکان‌پذیر نیست');
            return;
          }
        } else {
          showSuccess('اطلاعات با موفقیت ذخیره شد');
        }

        currentPasswordInput.value = '';
        newPasswordInput.value = '';
      } catch (error) {
        console.error('Error saving changes:', error);
        showError('خطا در ذخیره تغییرات: ' + getErrorMessage(error));
      }
    });

    // Cancel button
    cancelBtn.addEventListener('click', () => {
      Swal.fire({
        title: 'انصراف از تغییرات',
        text: 'آیا مطمئن هستید می‌خواهید از ذخیره تغییرات انصراف دهید؟',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'بله، انصراف',
        cancelButtonText: 'خیر، ادامه ویرایش',
        confirmButtonColor: 'var(--primary)',
        background: 'var(--bg-white)'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = 'profile.html';
        }
      });
    });

    // Helper function for error messages
    function getErrorMessage(error) {
      switch (error.code) {
        case 'auth/wrong-password':
          return 'رمز عبور فعلی نادرست است';
        case 'auth/weak-password':
          return 'رمز عبور جدید بسیار ضعیف است';
        case 'auth/requires-recent-login':
          return 'برای تغییر رمز عبور، لطفاً دوباره وارد شوید';
        case 'auth/invalid-credential':
          return 'اعتبارسنجی ناموفق بود';
        case 'permission-denied':
          return 'دسترسی به پایگاه داده محدود شده است';
        case 'database/unknown':
          return 'خطای ناشناخته در پایگاه داده';
        default:
          return error.message || 'خطای ناشناخته';
      }
    }

    // Helper functions for notifications
    function showError(message) {
      Swal.fire({
        title: 'خطا',
        text: message,
        icon: 'error',
        confirmButtonText: 'متوجه شدم',
        confirmButtonColor: 'var(--primary)',
        background: 'var(--bg-white)'
      });
    }

    function showSuccess(message) {
      Swal.fire({
        title: 'موفقیت',
        text: message,
        icon: 'success',
        confirmButtonText: 'درست است',
        confirmButtonColor: 'var(--primary)',
        background: 'var(--bg-white)'
      });
    }
  </script>
</body>
</html>