<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ماشین‌حساب امتیاز فانتزی - بازی چهارم</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #6a1b9a;
      --secondary-color: #ffab00;
      --dark-color: #2c3e50;
      --light-color: #f5f5f5;
      --danger-color: #e53935;
      --success-color: #43a047;
    }
    
    body { 
      font-family: Tahoma, sans-serif; 
      direction: rtl; 
      padding: 20px; 
      background-color: #fff; 
      color: #333; 
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h2 { 
      color: #800000; 
      text-align: center; 
    }
    
    fieldset { 
      border: 2px solid #800000; 
      border-radius: 10px; 
      margin: 20px 0; 
      padding: 15px; 
    }
    
    legend { 
      font-weight: bold; 
      color: #800000; 
      padding: 0 10px; 
    }
    
    label { 
      display: block; 
      margin-top: 10px; 
    }
    
    input[type="text"], 
    input[type="number"], 
    input[type="email"],
    input[type="password"],
    select { 
      padding: 8px 12px;
      margin-top: 5px; 
      font-size: 16px; 
      width: 100%; 
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    
    button { 
      margin-top: 10px; 
      padding: 10px 30px; 
      font-size: 16px; 
      background-color: #800000; 
      color: white; 
      border: none; 
      border-radius: 25px; 
      cursor: pointer; 
      transition: all 0.3s;
    }
    
    button:hover {
      background-color: #600000;
      transform: translateY(-2px);
    }
    
    ul { 
      padding-right: 20px; 
    }
    
    .checkbox-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      margin-top: 10px; 
    }
    
    .checkbox-list label { 
      margin: 0; 
      display: flex; 
      align-items: center; 
      gap: 5px; 
      cursor: pointer; 
    }
    
    .user-card { 
      border: 1px solid #ccc; 
      border-radius: 10px; 
      padding: 10px; 
      margin: 10px 0; 
      display: flex; 
      align-items: center; 
      gap: 15px; 
    }
    
    .user-card img { 
      width: 50px; 
      height: 50px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 2px solid #800000; 
    }
    
    .user-card .info { 
      flex-grow: 1; 
    }
    
    .results-container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      display: none;
    }
    
    .results-header {
      background: linear-gradient(135deg, var(--primary-color), #8e24aa);
      color: white;
      padding: 20px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-radius: 15px;
      margin-bottom: 30px;
    }
    
    .results-title {
      text-align: center;
      margin: 0;
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    
    .subtitle {
      text-align: center;
      opacity: 0.9;
      margin-top: 8px;
      font-size: 1rem;
    }
    
    .card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 15px;
      text-align: center;
      vertical-align: middle;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
    }
    
    tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    tr:hover {
      background-color: rgba(106, 27, 154, 0.05);
    }
    
    img.profile-pic {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--secondary-color);
      vertical-align: middle;
      margin-left: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .rank-cell {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 1.1rem;
    }
    
    .gold { color: #ffd700; }
    .silver { color: #c0c0c0; }
    .bronze { color: #cd7f32; }
    
    button.delete-btn {
      background-color: var(--danger-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    button.delete-btn:hover {
      background-color: #c62828;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    button.delete-btn i {
      margin-left: 6px;
    }
    
    .score-cell {
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(106, 27, 154, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .no-data {
      text-align: center;
      padding: 30px;
      color: var(--dark-color);
      font-size: 1.1rem;
    }
    
    .login-message {
      text-align: center;
      margin: 20px 0;
      color: var(--primary-color);
      font-weight: bold;
    }
    
    .debug-section {
      background-color: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    @media (max-width: 768px) {
      th, td {
        padding: 10px 8px;
      }
      
      .results-title {
        font-size: 1.8rem;
      }
      
      img.profile-pic {
        width: 35px;
        height: 35px;
      }
    }
    
    .trophy-icon {
      margin-left: 5px;
    }
    
    #appContent {
      display: none;
    }
  </style>
</head>
<body>

<h2>ماشین‌حساب امتیاز فانتزی - بازی چهارم</h2>

<!-- Admin Login Section -->
<fieldset id="loginSection">
  <legend>ورود ادمین</legend>
  <label>ایمیل:</label>
  <input type="email" id="adminEmail" placeholder="walizadamamoon@gmail.com" value="walizadamamoon@gmail.com" />
  <label>رمز عبور:</label>
  <input type="password" id="adminPassword" placeholder="mamoon123" value="mamoon123" />
  <button onclick="adminLogin()">ورود</button>
  <div id="loginMessage" class="login-message"></div>
</fieldset>

<!-- Main Application Content (hidden until login) -->
<div id="appContent">
  <fieldset>
    <legend>افزودن امتیاز بازیکنان</legend>
    <label>نام بازیکن:</label>
    <input type="text" id="playerName" placeholder="مثلا: علیرضا بیرانوند" />
    <label>امتیاز:</label>
    <input type="number" id="playerScore" placeholder="مثلا: 5" />
    <button onclick="addPlayer()">افزودن بازیکن</button>
    <ul id="playerList"></ul>
  </fieldset>

  <button onclick="calculateScores()">محاسبه امتیاز و رده‌بندی</button>
  
  <fieldset>
    <legend>اطلاعات دیباگ (برای توسعه‌دهندگان)</legend>
    <button onclick="showDebugInfo()">نمایش اطلاعات دیباگ</button>
    <div id="debugInfo" class="debug-section" style="display: none;"></div>
  </fieldset>

  <!-- Results Section -->
  <div id="resultsSection" class="results-container">
    <div class="results-header">
      <h1 class="results-title">رده‌بندی نهایی تیم‌های فانتزی - بازی چهارم</h1>
      <div class="subtitle">آخرین بروزرسانی: <span id="updateTime"></span></div>
    </div>

    <div class="card">
      <table id="resultsTable">
        <thead>
          <tr>
            <th width="10%">رتبه</th>
            <th width="60%">نام کاربر</th>
            <th width="20%">امتیاز کل</th>
            <th width="10%">عملیات</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" class="loading">
              <div class="spinner"></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDLfUbSG30O474XPAPY8QpMzo19EMfLWFc",
    authDomain: "josh-7b6a0.firebaseapp.com",
    databaseURL: "https://josh-7b6a0-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "josh-7b6a0",
    storageBucket: "josh-7b6a0.firebasestorage.app",
    messagingSenderId: "639816255525",
    appId: "1:639816255525:web:71a3e87374c3e7c68e17cc",
    measurementId: "G-P2ZSBTN8FP"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const auth = firebase.auth();

  // Variables to store data
  const playersScores = {};
  let teams = [];

  // Admin Login Function
  function adminLogin() {
    const email = document.getElementById('adminEmail').value.trim();
    const password = document.getElementById('adminPassword').value;
    const loginMessage = document.getElementById('loginMessage');
    
    loginMessage.textContent = '';
    loginMessage.style.color = 'var(--primary-color)';
    
    if (email !== 'walizadamamoon@gmail.com') {
      loginMessage.textContent = 'فقط ادمین اصلی می‌تواند وارد شود';
      loginMessage.style.color = 'var(--danger-color)';
      return;
    }
    
    auth.signInWithEmailAndPassword(email, password)
      .then((userCredential) => {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        loadPlayerScores();
      })
      .catch((error) => {
        loginMessage.textContent = 'خطا در ورود: ' + error.message;
        loginMessage.style.color = 'var(--danger-color)';
      });
  }

  // Add Player Function
  function addPlayer() {
    const name = document.getElementById('playerName').value.trim();
    const score = parseFloat(document.getElementById('playerScore').value);
    
    if (!name || isNaN(score)) {
      alert("لطفاً نام بازیکن و امتیاز معتبر وارد کنید.");
      return;
    }
    
    if (playersScores[name]) {
      if (!confirm("این بازیکن قبلاً اضافه شده است. آیا می‌خواهید امتیاز را به روز کنید؟")) {
        return;
      }
    }
    
    const currentUser = auth.currentUser;
    if (!currentUser || currentUser.email !== 'walizadamamoon@gmail.com') {
      alert('دسترسی غیرمجاز. لطفاً مجدداً وارد شوید.');
      return;
    }
    
    database.ref("fcricket_match4/player_scores/" + encodeURIComponent(name)).set(score)
      .then(() => {
        alert(`امتیاز ${name} با موفقیت ذخیره شد.`);
        document.getElementById('playerName').value = '';
        document.getElementById('playerScore').value = '';
        loadPlayerScores();
      })
      .catch(error => {
        alert("خطا در ذخیره امتیاز: " + error.message);
      });
  }

  // Calculate Scores Function
  async function calculateScores() {
    try {
      const tbody = document.querySelector("#resultsTable tbody");
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="loading">
            <div class="spinner"></div>
          </td>
        </tr>
      `;

      document.getElementById('resultsSection').style.display = 'block';
      
      // Get player scores
      const scoresSnapshot = await database.ref("fcricket_match4/player_scores").once("value");
      const scores = scoresSnapshot.val() || {};
      Object.assign(playersScores, scores);
      
      // Get team data
      const teamsSnapshot = await database.ref("fcricket_match4").once("value");
      const allData = teamsSnapshot.val();
      
      if (!allData) {
        showNoData();
        return;
      }

      teams = [];
      
      // Process each team
      Object.keys(allData).forEach(key => {
        if (key === "player_scores") return;
        
        const teamData = allData[key];
        
        // Skip if not a team object
        if (!teamData || typeof teamData !== 'object' || !teamData.players) return;
        
        let totalScore = 0;
        
        // Calculate players' scores
        teamData.players.forEach(playerName => {
          // Find player key with exact match
          const playerKey = Object.keys(playersScores).find(
            k => decodeURIComponent(k) === playerName
          );
          
          if (playerKey) {
            totalScore += playersScores[playerKey] || 0;
          }
        });
        
        // Add captain bonus (double points)
        if (teamData.captain) {
          const captainKey = Object.keys(playersScores).find(
            k => decodeURIComponent(k) === teamData.captain
          );
          if (captainKey) {
            totalScore += playersScores[captainKey] || 0;
          }
        }
        
        // Add vice-captain bonus (1.5x points)
        if (teamData.viceCaptain) {
          const viceCaptainKey = Object.keys(playersScores).find(
            k => decodeURIComponent(k) === teamData.viceCaptain
          );
          if (viceCaptainKey) {
            totalScore += (playersScores[viceCaptainKey] || 0) * 0.5;
          }
        }
        
        // Store team data
        teams.push({
          key: key,
          name: teamData.userInfo?.displayName || teamData.userInfo?.fullName || "ناشناس",
          phone: teamData.userInfo?.phone || "",
          photo: teamData.userInfo?.profilePhoto || "https://ui-avatars.com/api/?name=ناشناس&background=random",
          score: totalScore
        });
      });

      // Sort teams by score
      teams.sort((a, b) => b.score - a.score);
      renderResults();
      
    } catch (error) {
      console.error("خطا در محاسبه امتیازات:", error);
      showError("خطا در بارگذاری داده‌ها. لطفاً صفحه را مجدداً بارگذاری کنید.");
    }
  }

  // Render Results Function
  function renderResults() {
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = "";
    
    if (teams.length === 0) {
      showNoData();
      return;
    }

    teams.forEach((team, index) => {
      const row = document.createElement("tr");
      
      // Determine ranking style
      let rankClass = "";
      let trophyIcon = "";
      if (index === 0) {
        rankClass = "gold";
        trophyIcon = '<i class="fas fa-trophy trophy-icon"></i>';
      } else if (index === 1) {
        rankClass = "silver";
        trophyIcon = '<i class="fas fa-trophy trophy-icon"></i>';
      } else if (index === 2) {
        rankClass = "bronze";
        trophyIcon = '<i class="fas fa-trophy trophy-icon"></i>';
      }

      row.innerHTML = `
        <td class="rank-cell ${rankClass}">${index + 1} ${trophyIcon}</td>
        <td>
          <img class="profile-pic" src="${team.photo}" alt="عکس پروفایل" 
               onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(team.name)}&background=random'" />
          ${team.name}
          ${team.phone ? `<br/><small>${team.phone}</small>` : ''}
        </td>
        <td class="score-cell">${team.score.toFixed(2)}</td>
        <td>
          <button class="delete-btn" onclick="deleteTeam('${team.key}', '${team.name}')">
            <i class="fas fa-trash-alt"></i> حذف
          </button>
        </td>
      `;

      tbody.appendChild(row);
    });
    
    updateTime();
  }

  // Delete Team Function
  async function deleteTeam(teamKey, teamName) {
    if (!confirm(`آیا از حذف تیم "${teamName}" مطمئن هستید؟ این عملیات قابل بازگشت نیست.`)) {
      return;
    }
    
    try {
      const currentUser = auth.currentUser;
      if (!currentUser || currentUser.email !== 'walizadamamoon@gmail.com') {
        alert('دسترسی غیرمجاز. لطفاً مجدداً وارد شوید.');
        return;
      }
      
      await database.ref("fcricket_match4/" + teamKey).remove();
      alert(`تیم "${teamName}" با موفقیت حذف شد.`);
      calculateScores();
    } catch (err) {
      alert("خطا در حذف تیم: " + err.message);
    }
  }

  // Load Player Scores Function
  function loadPlayerScores() {
    database.ref("fcricket_match4/player_scores").on("value", snapshot => {
      const playerList = document.getElementById("playerList");
      playerList.innerHTML = "";
      
      const scores = snapshot.val() || {};
      Object.assign(playersScores, scores);
      
      Object.keys(scores).forEach(playerKey => {
        const playerName = decodeURIComponent(playerKey);
        const li = document.createElement("li");
        li.textContent = `${playerName}: ${scores[playerKey]}`;
        playerList.appendChild(li);
      });
    });
  }

  // Update Time Function
  function updateTime() {
    const now = new Date();
    const options = { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    };
    document.getElementById('updateTime').textContent = now.toLocaleDateString('fa-IR', options);
  }

  // Show Error Function
  function showError(message) {
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="no-data">
          <i class="fas fa-exclamation-circle" style="color: var(--danger-color); font-size: 2rem; margin-bottom: 15px;"></i>
          <br>
          ${message}
          <br>
          <button onclick="calculateScores()" style="margin-top: 15px; background: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
            <i class="fas fa-sync-alt"></i> تلاش مجدد
          </button>
        </td>
      </tr>
    `;
  }

  // Show No Data Function
  function showNoData() {
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="no-data">
          <i class="fas fa-info-circle" style="color: var(--primary-color); font-size: 2rem; margin-bottom: 15px;"></i>
          <br>
          هیچ داده‌ای برای نمایش وجود ندارد
        </td>
      </tr>
    `;
    updateTime();
  }

  // Debug function to show database structure
  async function showDebugInfo() {
    try {
      const debugInfo = document.getElementById('debugInfo');
      debugInfo.style.display = 'block';
      debugInfo.innerHTML = 'در حال دریافت اطلاعات...';
      
      const snapshot = await database.ref("fcricket_match4").once("value");
      const data = snapshot.val();
      
      if (!data) {
        debugInfo.innerHTML = 'هیچ داده‌ای در مسیر fcricket_match4 یافت نشد.';
        return;
      }
      
      let debugText = 'ساختار داده‌های fcricket_match4:\n\n';
      
      Object.keys(data).forEach(key => {
        debugText += `کلید: ${key}\n`;
        
        if (key === 'player_scores') {
          debugText += `  نوع: player_scores\n`;
          debugText += `  تعداد بازیکنان: ${Object.keys(data[key] || {}).length}\n`;
        } else {
          debugText += `  نوع: تیم کاربر\n`;
          if (data[key].userInfo) {
            debugText += `  نام کاربر: ${data[key].userInfo.fullName || 'نامشخص'}\n`;
          }
          debugText += `  تعداد بازیکنان: ${(data[key].players && data[key].players.length) || 0}\n`;
        }
        
        debugText += '\n';
      });
      
      debugInfo.textContent = debugText;
    } catch (error) {
      document.getElementById('debugInfo').textContent = 'خطا در دریافت اطلاعات: ' + error.message;
    }
  }

  // Check Auth State
  auth.onAuthStateChanged((user) => {
    if (user && user.email === 'walizadamamoon@gmail.com') {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';
      loadPlayerScores();
    } else {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('appContent').style.display = 'none';
    }
  });
</script>

</body>
</html>